---
title: "Handling Infinite Edges"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Handling Infinite Edges}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(rvoronoi)
```

Voronoi tesselation applies to an infinite plane which means that some edges
are unbounded.

In order to draw these edges, we must bound their extent (so we have two endpoints 
to plot the line between)

`voronoi()` returns the line equation for each edge in the form `ax + by = c`.
Each edge is then a triplet of `line equation`, `first vertex` and `second vertex`
on that line.  If the line goes to infinity, then that vertex takes the value
`NA`.


## Bounding infinite segments

```{r fig.height = 6, fig.width = 6}
set.seed(1)
N <- 10
x <- runif(N)
y <- runif(N)
# x <- c(0, 1, 2)
# y <- 0.05 * x


vor <- voronoi(x, y)

dw <- 0.2
lim <- c(0 - dw, 1 + dw)

# Plotting all the finite segments
buf <- 0.1
plot(x, y, col = 'black', pch = '+',
     asp = 1, ann = FALSE, axes = FALSE, 
     xlim = c(vor$extents$xmin - buf, vor$extents$xmax + buf), 
     ylim = c(vor$extents$ymin - buf, vor$extents$ymax + buf)
)

# Finite segments
fseg <- vor$segment
fseg <- subset(fseg, v1 > 0 & v2 > 0)

segments(
  vor$vertex$x[fseg$v1], vor$vertex$y[fseg$v1],
  vor$vertex$x[fseg$v2], vor$vertex$y[fseg$v2]
)

# Bounds
with(vor$extents, rect(xmin, ymin, xmax, ymax, border = 'grey90'))

with(vor$extents, rect(xmin - buf, ymin - buf, xmax + buf, ymax + buf, border = 'grey40'))


# Add in the lines representing infinite segments
# Extract segments which are unbounded. i.e. v1 or v2 is NA
inf_seg <- subset(vor$segment, v1 < 0 | v2 < 0)


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Find the intersections with the rectangular boundary
#
#  CORNER CASES
#     * vertical line
#     * horizontal line
#     * unbounded edge in 2 directions
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
seg_idx <- 1
for (seg_idx in seq_len(nrow(inf_seg))) {
  
  seg <- inf_seg[seg_idx,]
  ll  <- vor$line[seg$line,]
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # Voronoi point
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  type <- 0
  x0   <- NA_real_
  y0   <- NA_real_
  if (seg$v1 > 0) {
    type <- 2
    x0   <- vor$vertex$x[seg$v1]
    y0   <- vor$vertex$y[seg$v1]
  } else if (seg$v2 > 0) {
    type <- 1
    x0   <- vor$vertex$x[seg$v2]
    y0   <- vor$vertex$y[seg$v2]
  }
  points(x0, y0, pch = 19, col = 'blue')
  
  
  # There can only be 2 intercept points which lie on the boundary
  intercepts <- list(NULL, NULL)
  
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # intersection with left edge
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  pleft <- list(
    x = vor$extents$xmin,
    y = with(ll, (c - a * vor$extents$xmin)/b)
  )
  
  # Is it within the uuppler/lower bounds
  if (pleft$y >= vor$extents$ymin && pleft$y <= vor$extents$ymax) {
    intercepts[[1]] <- pleft # This intercept is on the left
  }
  
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # intersection with right edge
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  pright <- list(
    x = vor$extents$xmax,
    y = with(ll, (c - a * vor$extents$xmax)/b)
  )
  
  # Is it within the upper/lower bounds
  if (pright$y >= vor$extents$ymin && pright$y <= vor$extents$ymax) {
    intercepts[[2]] <- pright
  }
  
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # intersection with lower edge
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  plower <- list(
    y = vor$extents$ymin,
    x = with(ll, (c - b * vor$extents$ymin)/a)
  )
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # intersection with upper edge
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  pupper <- list(
    y = vor$extents$ymax,
    x = with(ll, (c - b * vor$extents$ymax)/a)
  )
  
  if (is.null(intercepts[[1]])) {
    if (plower$x < pupper$x) 
      intercepts[[1]] <- plower
    else 
      intercepts[[1]] <- pupper
  }
  
  
  if (is.null(intercepts[[2]])) {
    if (pupper$x > plower$x) 
      intercepts[[2]] <- pupper
    else 
      intercepts[[2]] <- plower
  }
  
  
  
  
  if (type == 0) {
    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # Double ended unbounded edge
    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    segments(intercepts[[1]]$x, intercepts[[1]]$y, intercepts[[2]]$x, intercepts[[2]]$y, col = 'orange')
  } else if (type == 1) {
      segments(x0, y0, intercepts[[1]]$x, intercepts[[1]]$y, col = 'red')
  } else {
      segments(x0, y0, intercepts[[2]]$x, intercepts[[2]]$y, col = 'red')
  }
  
}
```























